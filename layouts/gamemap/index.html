{{ define "main" }}
<div class="loading-screen">
    <div class="loading">
        <h1>Loading...</h1>
        <div class="loader"></div>
    </div>
    <div class="loaded hidden">
        <button class="start-game">Start</button>
    </div>
    <div>
        Controls:<br>
        Move: WASD or arrow keys or touch/move<br>
        Open/Close: Spacebar or Enter or click/touch
    </div>
</div>

<canvas id="map" class="hidden"></canvas>

<template id="modal-template">
    <div class="backdrop">
        <div class="lightbox">
            <div class="lightbox-footer">
                <a class="img-link" target="_blank" rel="noopener">
                    Open in new tab
                </a>
            </div>

            <span class="close"></span>
        </div>
    </div>
</template>

<script type="text/javascript">
    {{ $gregor := .Page.Resources.GetMatch "gregor.png" }}
    const gregorPaths = {"png": {{ $gregor.RelPermalink }}, "webp": {{ ($gregor.Resize "450x webp").RelPermalink }}};
    {{ $pages := .RegularPages -}}
    const games = [
        {{- range $index, $element := $pages }}
            {{- $imageOrig := (.Resources.ByType "image").GetMatch "image.*" }}

            {{- $image1500 := "" -}}
            {{- if gt $imageOrig.Width 1500 -}}
                {{- $image1500 = $imageOrig.Resize "1500x" -}}
            {{- end -}}

            {{- $imageWebp := "" -}}
            {{- $imageWebp1500 := "" -}}
            {{- if or (eq $imageOrig.MediaType.SubType "png") -}}
                {{- $imageWebp = $imageOrig.Resize (printf "%dx webp" $imageOrig.Width) -}}
                {{- if gt $imageOrig.Width 1500 -}}
                    {{- $imageWebp1500 = $imageOrig.Resize "1500x webp" -}}
                {{- end -}}
            {{- end -}}

            {{- $landmarkImage := (.Resources.ByType "image").GetMatch "landmark.*" }}
            {{- $reziedLandmarkImage := $landmarkImage.Fit "170x150" }}
            {{- $reziedLandmarkImageWebp := $landmarkImage.Fit "170x150 webp" }}
        {
            "title": {{ .Title }},
            "author": {{ .Params.author }},
            "authorLink": {{ .Params.author_link }},
            "pos": {{ .Params.pos }},
            "image": {"img": {{ $imageOrig.RelPermalink }}, "srcset": "{{ with $image1500 }}{{ .RelPermalink }} 1500w, {{ end }}{{ $imageOrig.RelPermalink }} {{ $imageOrig.Width }}w" {{- if $imageWebp }}, "webpSrcset": "{{ with $imageWebp1500 }}{{ .RelPermalink }} 1500w, {{ end }}{{ $imageWebp.RelPermalink }} {{ $imageWebp.Width }}w" {{ end }}},
            "landmark": {"png": "{{ $reziedLandmarkImage.RelPermalink }}", "webp": "{{ $reziedLandmarkImageWebp.RelPermalink }}"},
        }{{ if not (eq (add $index 1) (len $pages)) }},{{ end }}
        {{- end }}
    ]
</script>
{{ $main_js := resources.Get "/js/gamemap.js" | minify | fingerprint "sha512" }}
<script src="{{ $main_js.RelPermalink }}" integrity="{{ $main_js.Data.Integrity }}" defer></script>
{{ end -}}
